{% extends "base.html" %}
{% block title %}Attendance — Admin{% endblock %}
{% block header %}
<div class="flex items-center justify-between">
  <div>
    <h1 class="text-2xl font-semibold">Attendance</h1>
    <p class="text-sm text-slate-500">Start/End session and view logs.</p>
  </div>
  <div class="flex gap-2">
    <button id="startBtn" class="btn-primary">Start Attendance</button>
    <button id="endBtn" class="btn-outline">End Attendance</button>
  </div>
</div>
{% endblock %}
{% block content %}
<div id="sessionBanner" class="card p-4 mb-4 hidden"></div>

<div class="card p-0 overflow-hidden">
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr><th class="w-40">Time</th><th class="w-28">Student ID</th><th>RFID</th><th>Face</th></tr>
      </thead>
      <tbody id="logsBody">
        <tr><td colspan="4" class="py-6 text-center text-slate-500">No logs yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
const el = id => document.getElementById(id);
const api = async (p,o={})=>{
  const r = await fetch(p,{headers:{'Content-Type':'application/json'},...o});
  if(!r.ok) throw new Error(await r.text()); return r.json();
};

let activeSessionId = null;

async function sendCommand(cmd, payload={}){
  // Replace with real bridge later (MQTT/HTTP to Pi)
  await api('/cmd', { method:'POST', body: JSON.stringify({ type: cmd, ...payload }) });
}

async function refreshSession(){
  const s = await api('/sessions/active');
  if(!s || !s.id){
    activeSessionId = null;
    el('sessionBanner').classList.add('hidden');
    return;
  }
  activeSessionId = s.id;
  el('sessionBanner').classList.remove('hidden');
  el('sessionBanner').innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <div class="font-semibold">Active: ${s.course_code} (ID ${s.id})</div>
        <div class="text-xs text-slate-500">Started: ${new Date(s.started_at).toLocaleString()}</div>
      </div>
      <div class="text-xs text-green-600">Live</div>
    </div>`;
  loadLogs();
}

async function startAttendance(){
  const code = prompt('Course code?', 'CPEN104');
  if(!code) return;
  await api('/sessions', { method:'POST', body: JSON.stringify({ course_code: code })});
  await sendCommand('start_attendance', { course_code: code });
  refreshSession();
}

async function endAttendance(){
  await sendCommand('end_attendance', { session_id: activeSessionId });
  alert('End command sent. (Implement close-session API later.)');
}

async function loadLogs(){
  if(!activeSessionId) return;
  const rows = await api('/attendance?session_id=' + activeSessionId);
  const body = el('logsBody');
  body.innerHTML = rows.length ? rows.map(r=>`
    <tr>
      <td>${new Date(r.created_at).toLocaleTimeString()}</td>
      <td>${r.student_id}</td>
      <td>${r.rfid_ok ? '✔️' : '—'}</td>
      <td>${r.face_ok ? '✔️' : '—'}</td>
    </tr>`).join('')
    : `<tr><td colspan="4" class="py-6 text-center text-slate-500">No logs yet.</td></tr>`;
}

el('startBtn').onclick = startAttendance;
el('endBtn').onclick = endAttendance;
refreshSession();
setInterval(loadLogs, 4000);
</script>
{% endblock %}
